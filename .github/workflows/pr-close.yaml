name: Tear down preview environment for pull request

on:
  pull_request:
    types:
      - closed

# Cancel any in progress since we are shutting down
concurrency:
  cancel-in-progress: true
  group: "preview-env-manage-${{ github.event.number }}"

env:
  APP_NAME: ${{ github.event.repository.name }}
  COPILOT_SERVICE: mindlogger-backend
  AWS_REGION: us-east-1


jobs:
  destroy-preview-env:
    name: Destroy preview env
    uses: ./.github/workflows/destroy-preview-env.yaml
    with:
      env-name: "pr-${{ github.event.number }}"
      app-id: d2ojy049t6jawn

  comment-destroy-preview-env:
    name: Comment on preview env
    runs-on: ubuntu-latest
    needs: [ destroy-preview-env ]
    if: ${{ always() }}
    steps:
      - name: Comment on PR
        uses: thollander/actions-comment-pull-request@v2
        with:
          message: |
            :arrow_right: Preview environment failed to be destroyed
          comment_tag: preview-env
      - name: "Send Slack message on failure"
        uses: rtCamp/action-slack-notify@v2
        if: ${{ always() && needs.destroy-preview-env.result == 'failure' }}
        env:
          SLACK_COLOR: failure
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_TEST_RESULTS }}
          SLACK_TITLE: |
            :rotating_light: Preview Environment Destroy Failed
          SLACK_MESSAGE: >- 
            Failed to destroy preview environment pr-${{ github.event.number }} for ${{ github.repository }}
            \n\n
            :arrow_right: [Action Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            \n\n
            :label: [Pull Request](${{ github.event.pull_request.html_url || github.event.head_commit.url }})
          MSG_MINIMAL: true